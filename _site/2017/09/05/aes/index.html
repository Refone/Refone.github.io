<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>AES 加密解读 - 刘瑞丰的博客 | Refone's Blog</title>

    <link rel="canonical" href="http://localhost:4000/2017/09/05/aes/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Refone's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/aes-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/aes-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#加密" title="加密">加密</a>
                        
                        <a class="tag" href="/tags/#安全" title="安全">安全</a>
                        
                    </div>
                    <h1>AES 加密解读</h1>
                    
                    
                    <h2 class="subheading">如果你不满足于黑盒加密算法</h2>
                    
                    <span class="meta">Posted by Refone on September 5, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <blockquote>
  <p>本博文是通过阅读博文<a href="http://www.mamicode.com/info-detail-514466.html">[1]</a>，并结合项目<a href="https://github.com/dhuertas/AES">[2]</a>所写，图片大部分来自wiki百科。通过一系列概念的补充和一个具体实例的示范加深理解。</p>
</blockquote>

<h2 id="准备原料">准备原料</h2>

<p>这里的原料指的是进行一次最基本的AES加密所需要具备的除源数据以外的东西。本博文暂时讨论128位的AES加密，除128位的AES加密还有192位与256位的AES加密，后文会稍稍提及，不过主要内容讨论的是128位的AES加密。</p>

<p><strong>加密公式：</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>key(4×4×8bit) + 原文(4×4×8bit) = 密文(4×4×8bit)   //（4×4×8=128)
</code></pre>
</div>

<p>这是AES加密的最小单位。对应的AES192和AES256基本长度就是4×4×12和4×4×16.</p>

<p><strong>1.密钥</strong></p>

<p>如上公式所描述，我们需要一个128位的密钥，也就是用户设定的key。</p>

<p><strong>2.转化表</strong></p>

<div align="center"><img src="/img/in-post/aes/s-box.png" /></div>
<div align="center"><img src="/img/in-post/aes/inverse_S-box.png" /></div>

<p>假设字节0x00经由转化表S-box就得S(0x00) = S[0][0] = 0x63.</p>

<p>同理，逆向过程为S<sup>-1</sup>(0x63) = S<sup>-1</sup><a href="https://en.wikipedia.org/wiki/Finite_field_arithmetic">6</a> = 0x00.</p>

<p><strong>3.回合金钥(Round Key)</strong></p>

<p>中文wiki百科把subRoundkey翻译为回合金钥。回合金钥与轮数有关，AES中128位元密钥有10个加密轮回，192位元有12个加密轮回，256位元有14个加密轮回，而每一个加密轮回需要用到一个回合金钥，也就是有多少个加密轮回就需要多少回合金钥，<strong>每一轮回的回合金钥长度与key相同</strong>。所有的回合金钥由密钥(key)扩展得到。回合金钥的制作过程如图所示：</p>

<div align="center"><img src="/img/in-post/aes/gen-round-key.png" width="400" height="400" /></div>

<p>密钥扩展过程说明：</p>

<p>  1)  将初始密钥以列为主，转化为4个32 bits的字，分别记为<script type="math/tex">w[0…3]</script>；</p>

<p>  2)  按照如下方式，依次求解<script type="math/tex">w[j]</script>，其中<script type="math/tex">j</script>是整数并且属于<script type="math/tex">[4,43]</script>；</p>

<p>  3)  若<script type="math/tex">j\%4=0</script>,则 <script type="math/tex">w[j]=w[j-4] \bigoplus g(w[j-1])</script> ,否则 <script type="math/tex">w[j]=w[j-4]\bigoplus w[j-1]</script>；</p>

<p>　　函数g的流程说明：</p>

<p>  4)  将<script type="math/tex">w</script>循环左移一个字节；</p>

<p>  5)  分别对每个字节按S盒进行映射；</p>

<p>  6)  与32 bits的常量<script type="math/tex">(RC[j/4],0,0,0)</script>进行异或，<script type="math/tex">RC</script>是一个一维数组，其值如下。（<script type="math/tex">RC</script>的值只需要有10个，而此处用了11个，实际上<script type="math/tex">RC[0]</script>在运算中没有用到，增加<script type="math/tex">RC[0]</script>是为了便于程序中用数组表示。由于<script type="math/tex">j</script>的最小取值是4，<script type="math/tex">j/4</script>的最小取值则是1，因此不会产生错误。）</p>

<script type="math/tex; mode=display">RC = {00, 01, 02, 04, 08, 10, 20, 40, 80, 1B, 36}</script>

<p>项目中生成回合金钥的代码片段有两个参数需要解释：</p>

<p><strong>Nk</strong>：key是32-bit的多少倍，128位元的Nk=4（如上图有灰橙绿蓝四列）。</p>

<p><strong>Nr</strong>：加密轮回，128位元本例采用的Nr=10。</p>

<p>用代码表示回合金钥expansion流程如下：</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cm">/*
 * Key Expansion
 */</span>
<span class="kt">void</span> <span class="nf">key_expansion</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kt">uint8_t</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">Nb</span><span class="o">*</span><span class="p">(</span><span class="n">Nr</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Nk</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">Nk</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="n">Nk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="n">rot_word</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
            <span class="n">sub_word</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
            <span class="n">coef_add</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">Rcon</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">Nk</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
            
        <span class="p">}</span>
        
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">Nk</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">^</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">Nk</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">Nk</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">^</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">Nk</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">^</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>当初始<code class="highlighter-rouge">key = {00,01,02,03,  04,05,06,07,  08,09,0a,0b,  0c,0d,0e,0f}</code>时，轮回金钥制作结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>00010203 04050607 08090a0b 0c0d0e0f //w[0~15] w[(0~3)*Nk + (0~3)]
d6aa74fd d2af72fa daa678f1 d6ab76fe //w[16~31] w[(4~7)*Nk + (0~3)]
b692cf0b 643dbdf1 be9bc500 6830b3fe
b6ff744e d2c2c9bf 6c590cbf 0469bf41
47f7f7bc 95353e03 f96c32bc fd058dfd
3caaa3e8 a99f9deb 50f3af57 adf622aa
5e390f7d f7a69296 a7553dc1 0aa31f6b
14f9701a e35fe28c 440adf4d 4ea9c026
47438735 a41c65b9 e016baf4 aebf7ad2
549932d1 f0855768 1093ed9c be2c974e
13111d7f e3944a17 f307a78b 4d2b30c5
</code></pre>
</div>

<h2 id="轮回过程">轮回过程</h2>
<p>每一轮有四个过程：字节替代(subBytes)，行移位(shiftRows)，列混淆(mixColumns)，轮回金钥加密(addRoundKey)。第一轮之前首先进行一次addRoundKey，最后一轮不用addRoundKey。用代码理解就是：</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">Nb</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span><span class="p">[</span><span class="n">Nb</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">add_round_key</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">Nr</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
        <span class="n">inv_sub_bytes</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
        <span class="n">add_round_key</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
        <span class="n">inv_mix_columns</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">inv_shift_rows</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">inv_sub_bytes</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">add_round_key</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>
<p>state为每轮加密完成后的状态，最开始state为输入明文in[]。接下来阐述每一个过程：</p>

<h3 id="字节替代-the-subbytes-step">字节替代 (The SubBytes step)</h3>

<p>就是根据S-box转换表转换，上面已经提到了转换方法。</p>

<h3 id="行移位-the-shiftrows-step">行移位 (The ShiftRows step)</h3>

<p>如图矩阵中一个方块代表一个state字节(8-bit)，实际移位的操作即是：第一行保存不变，第二行循环左移1个字节，第三行循环左移2个字节，第四行循环左移3个字节</p>

<p><img src="/img/in-post/aes/shiftrows.png" width="400" /></p>

<h3 id="列混淆-the-mixcolumns-step">列混淆 (The MixColumns step)</h3>

<p>简单来讲就是state矩阵左乘一个固定矩阵<script type="math/tex">A</script></p>

<p><img src="/img/in-post/aes/mixcolumns.png" width="400" /></p>

<p>为何是矩阵<script type="math/tex">A</script> = {02,01,01,03},{03,02,01,01},{01,03,02,01},{01,01,03,02}，暂时不明白，AES标准的意思是这个矩阵是固定的，不过按加密思路来说是可以的，只要保证解密的时候用的矩阵和该矩阵互逆即可(<script type="math/tex">A\cdot A^{-1}= I</script>, <script type="math/tex">I</script>为单位矩阵)。</p>

<p>列混淆官方一点说法是，每一列都在modulo <script type="math/tex">x^4+1</script> 之下，与固定多项式<script type="math/tex">c(x)=3x^{3}+x^{2}+x+2</script>按有限域算法相乘（有限域乘法后面专门有部分讲述），<a href="https://github.com/dhuertas/AES">[2]</a>中代码也是这样表示的：</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">mix_columns</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kt">uint8_t</span> <span class="n">a</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">};</span> <span class="c1">// a(x) = {02} + {01}x + {01}x2 + {03}x3
</span>    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">Nb</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Nb</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>
        
        <span class="n">coef_mult</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span><span class="p">[</span><span class="n">Nb</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>coef_mult实现的是<script type="math/tex">\{a_0a_1a_2a_3\} \cdot \{b_0b_1b_2b_3\}</script>在<script type="math/tex">RP</script>=10001时的有限域乘法。代码如下：</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cm">/*
 * Multiplication of 4 byte words
 * m(x) = x4+1
 */</span>
<span class="kt">void</span> <span class="nf">coef_mult</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">^</span><span class="n">gmult</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>不过最终两种版本的解释殊途同归，都做了一样的事，有一样的结果——将state左乘了矩阵<script type="math/tex">A</script>。</p>

<h3 id="轮回金钥加密the-addroundkey-step">轮回金钥加密（The AddRoundKey step）</h3>
<p>每一轮state有16个byte，正好每一轮的轮回金钥也有16个byte，将他们对应异或就可实现该步骤。即：</p>

<script type="math/tex; mode=display">state[i][j]' = state[i][j] \bigoplus w[r \ast Nk + i \ast 4 + j]</script>

<p>也就是</p>

<script type="math/tex; mode=display">state = state \bigoplus w[r \ast Nk + (0..15)]</script>

<p><br />
笔记末尾有一个加密实例。至于为什么要进行这么复杂的步骤，貌似跟密码学有关系，满足扩散性非线性什么的，这里就没有深究下去了，认怂。</p>

<p>关于AES的一切加密都是可逆的，只要掌握key，可以由密文推导出原文。笔记不再累述，<a href="https://github.com/dhuertas/AES">[2]</a>中有相应呈现。</p>

<h2 id="有限域算法3">有限域算法<sup><a href="https://en.wikipedia.org/wiki/Finite_field_arithmetic">[3]</a></sup></h2>

<h3 id="有限域加法">有限域加法</h3>
<p>有限域加法采用异或法则</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left"><script type="math/tex">p_1</script></th>
      <th style="text-align: left"><script type="math/tex">p_2</script></th>
      <th style="text-align: left"><script type="math/tex">p_1+p_2</script><script type="math/tex">(normal</script> <script type="math/tex">algebra)</script></th>
      <th style="text-align: left"><script type="math/tex">p_1+p_2</script> in <script type="math/tex">GF(2^2)</script></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><script type="math/tex">x^3+x+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^3+x^2</script></td>
      <td style="text-align: left"><script type="math/tex">2x^3+x^2+x+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+x+1</script></td>
    </tr>
    <tr>
      <td style="text-align: left"><script type="math/tex">x^4+x^2</script></td>
      <td style="text-align: left"><script type="math/tex">x^6+x^2</script></td>
      <td style="text-align: left"><script type="math/tex">x^6+x^4+2x^2</script></td>
      <td style="text-align: left"><script type="math/tex">x^6+x^4</script></td>
    </tr>
    <tr>
      <td style="text-align: left"><script type="math/tex">x+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+x+2</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+x</script></td>
    </tr>
    <tr>
      <td style="text-align: left"><script type="math/tex">x^3+x</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^3+x^2+x+1</script></td>
      <td style="text-align: left"><script type="math/tex">x^3+x^2+x+1</script></td>
    </tr>
    <tr>
      <td style="text-align: left"><script type="math/tex">x^2+x</script></td>
      <td style="text-align: left"><script type="math/tex">x^2+x</script></td>
      <td style="text-align: left"><script type="math/tex">2x^2+2x</script></td>
      <td style="text-align: left"><script type="math/tex">0</script></td>
    </tr>
  </tbody>
</table>

<p>上表中的5个例子前三个用二进制算式表示即为：</p>

<script type="math/tex; mode=display">1011_2 + 1100_2 = 0111_2</script>

<script type="math/tex; mode=display">10100_2 + 1000100_2 = 1010000_2</script>

<script type="math/tex; mode=display">11_2 + 101_2 = 110_2</script>

<h3 id="有限域乘法">有限域乘法</h3>

<p>例如<script type="math/tex">{7_{16}} \cdot {11_{16}} = 0111_{2} \cdot 1011_{2} =   110001_{2} = 49_{16}</script> （注意加法部分仍是异或方式）</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    111 ×
   1011 =
   ------
    111 +
   1110 +
 111000 =
 --------
 110001
</code></pre>
</div>

<p>不过当位数大于等于7位时，需要一个<font color="blue" style="font-weight:bold">reduce it modulo the reduction polynomial</font>过程，即乘法结果除一个数（<font color="blue" style="font-weight:bold">reducing polynomial</font>，暂时称其为RP），余数才是最终结果，RP怎么来的目前不清楚，估计跟位数有关系，不过但凡牵扯到乘法都会给出（<a href="https://github.com/dhuertas/AES">[2]</a>中代码里也会有注释）。</p>

<p>wiki中的例子：</p>

<p>给出<script type="math/tex">RP = x^8 + x^4 + x^3 + x + 1</script>. （<script type="math/tex">100011011_2</script>）</p>

<script type="math/tex; mode=display">53_{16} \cdot CA_{16} = 01_{16}</script>

<script type="math/tex; mode=display">01010011_2 \cdot 11001010_2 = 11111101111110_2</script>

<p>然后 <script type="math/tex">11111101111110_2 \ mod \ 100011011_2</script></p>

<div class="highlighter-rouge"><pre class="highlight"><code>         ----------------      
          11111101111110  (mod) 100011011
          100011011
          ---------------     
           1110000011110
           100011011
           --------------
            110110101110
            100011011
            -------------   
             10101110110
             100011011
             ------------  
              0100011010
               100011011
               ---------- 
                00000001
</code></pre>
</div>

<p>所以最后结果为<script type="math/tex">01_2</script>.</p>

<h2 id="aes加密实例">AES加密实例</h2>

<ol>
  <li>我们给出<strong>key</strong>:</li>
</ol>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>    <span class="cm">/* 128 bit key */</span>
     <span class="kt">uint8_t</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> 
     <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> 
     <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> 
     <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">};</span>
</code></pre>
</div>

<ol>
  <li>给出<strong>原文</strong>:</li>
</ol>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>    <span class="kt">uint8_t</span> <span class="n">in</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
    <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span>
    <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span>
    <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
</code></pre>
</div>

<ol>
  <li>
    <p><strong>转换表</strong>和<strong>逆转换表</strong>(S-box，Inverse S-box)采用【准备原料】小节中给出的那张表</p>
  </li>
  <li>
    <p><strong>轮回金钥</strong>由key推导出如下：</p>
  </li>
</ol>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="mo">00010203</span> <span class="mo">04050607</span> <span class="mi">08090</span><span class="n">a0b</span> <span class="mi">0</span><span class="n">c0d0e0f</span>    <span class="c1">//w[0~15] w[(0~3)*Nk + (0~3)]
</span><span class="n">d6aa74fd</span> <span class="n">d2af72fa</span> <span class="n">daa678f1</span> <span class="n">d6ab76fe</span>    <span class="c1">//w[16~31] w[(4~7)*Nk + (0~3)]
</span><span class="n">b692cf0b</span> <span class="mi">643</span><span class="n">dbdf1</span> <span class="n">be9bc500</span> <span class="mi">6830</span><span class="n">b3fe</span>
<span class="n">b6ff744e</span> <span class="n">d2c2c9bf</span> <span class="mi">6</span><span class="n">c590cbf</span> <span class="mo">046</span><span class="mi">9</span><span class="n">bf41</span>
<span class="mi">47</span><span class="n">f7f7bc</span> <span class="mf">95353e03</span> <span class="n">f96c32bc</span> <span class="n">fd058dfd</span>
<span class="mi">3</span><span class="n">caaa3e8</span> <span class="n">a99f9deb</span> <span class="mi">50</span><span class="n">f3af57</span> <span class="n">adf622aa</span>
<span class="mf">5e390</span><span class="n">f7d</span> <span class="n">f7a69296</span> <span class="n">a7553dc1</span> <span class="mi">0</span><span class="n">aa31f6b</span>
<span class="mi">14</span><span class="n">f9701a</span> <span class="n">e35fe28c</span> <span class="mi">440</span><span class="n">adf4d</span> <span class="mi">4</span><span class="n">ea9c026</span>
<span class="mi">47438735</span> <span class="n">a41c65b9</span> <span class="n">e016baf4</span> <span class="n">aebf7ad2</span>
<span class="mi">549932</span><span class="n">d1</span> <span class="n">f0855768</span> <span class="mi">1093</span><span class="n">ed9c</span> <span class="n">be2c974e</span>
<span class="mi">13111</span><span class="n">d7f</span> <span class="n">e3944a17</span> <span class="n">f307a78b</span> <span class="mi">4</span><span class="n">d2b30c5</span>
</code></pre>
</div>

<p>轮回加密过程图如下：</p>

<p><img src="/img/in-post/aes/encryption_round.png" width="400" /></p>

<p>前五个步骤① ~ ⑤的状态如下：</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">初始</span><span class="n">addRoundKey</span><span class="p">(</span><span class="err">轮回金钥加密</span><span class="p">)</span><span class="o">:</span>
<span class="mo">00</span> <span class="mi">40</span> <span class="mi">80</span> <span class="n">c0</span>
<span class="mi">10</span> <span class="mi">50</span> <span class="mi">90</span> <span class="n">d0</span>
<span class="mi">20</span> <span class="mi">60</span> <span class="n">a0</span> <span class="n">e0</span>
<span class="mi">30</span> <span class="mi">70</span> <span class="n">b0</span> <span class="n">f0</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="err">第</span><span class="mi">1</span><span class="err">轮</span><span class="n">subBytes</span><span class="p">(</span><span class="err">字节替换</span><span class="p">)</span><span class="o">:</span>
<span class="mi">63</span> <span class="mi">09</span> <span class="n">cd</span> <span class="n">ba</span>
<span class="n">ca</span> <span class="mi">53</span> <span class="mi">60</span> <span class="mi">70</span>
<span class="n">b7</span> <span class="n">d0</span> <span class="n">e0</span> <span class="n">e1</span>
<span class="mo">04</span> <span class="mi">51</span> <span class="n">e7</span> <span class="mi">8</span><span class="n">c</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="err">第</span><span class="mi">1</span><span class="err">轮</span><span class="n">shiftRows</span><span class="p">(</span><span class="err">行移位</span><span class="p">)</span><span class="o">:</span>
<span class="mi">63</span> <span class="mi">09</span> <span class="n">cd</span> <span class="n">ba</span>
<span class="mi">53</span> <span class="mi">60</span> <span class="mi">70</span> <span class="n">ca</span>
<span class="n">e0</span> <span class="n">e1</span> <span class="n">b7</span> <span class="n">d0</span>
<span class="mi">8</span><span class="n">c</span> <span class="mo">04</span> <span class="mi">51</span> <span class="n">e7</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="err">第</span><span class="mi">1</span><span class="err">轮</span><span class="n">mixColums</span><span class="p">(</span><span class="err">列混淆</span><span class="p">)</span><span class="o">:</span>
<span class="mi">5</span><span class="n">f</span> <span class="mi">57</span> <span class="n">f7</span> <span class="mi">1</span><span class="n">d</span>
<span class="mi">72</span> <span class="n">f5</span> <span class="n">be</span> <span class="n">b9</span>
<span class="mi">64</span> <span class="n">bc</span> <span class="mi">3</span><span class="n">b</span> <span class="n">f9</span>
<span class="mi">15</span> <span class="mi">92</span> <span class="mi">29</span> <span class="mi">1</span><span class="n">a</span>
<span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="err">第</span><span class="mi">1</span><span class="err">轮</span><span class="n">addRoundKey</span><span class="p">(</span><span class="err">轮回金钥加密</span><span class="p">)</span><span class="o">:</span>
<span class="mi">89</span> <span class="mi">85</span> <span class="mi">2</span><span class="n">d</span> <span class="n">cb</span>
<span class="n">d8</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">18</span> <span class="mi">12</span>
<span class="mi">10</span> <span class="n">ce</span> <span class="mi">43</span> <span class="mi">8</span><span class="n">f</span>
<span class="n">e8</span> <span class="mi">68</span> <span class="n">d8</span> <span class="n">e4</span>
</code></pre>
</div>

<h2 id="aes加密模式5">AES加密模式<sup><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">[5]</a></sup></h2>

<p>以上说明的是AES单位粒度的加密流程，以128位AES加密来说，上面的流程完成了16byte(128bit)明文到16byte(128bit)密文的转换。对于更长的用户数据，大到几个GB的数据，以AES的标准又该如何去加密呢？这里常用的有三种加密方式(ECB，CBC，CTR)</p>

<h3 id="ecbelectronic-codebook-book-电码本模式">ECB(Electronic Codebook Book) ——电码本模式</h3>

<p>这种加密模式就是最简单粗暴的将数据切分成若干个128bit，然后对每一个128bit进行单位粒度的AES加密。每一个128bit的区块可以单独拿出来加密或者解密，不影响其他区块，正因如此，加密解密均可并行。但安全性较差，攻击者不难列出128bit所有明文到密文的映射表，然后通过查表的方式就可以从密文知道对应明文。（添加随机的salt是对这种列表攻击比较好的防御）</p>

<p><img src="/img/in-post/aes/ecb.png" width="400" /></p>

<h3 id="cbccipher-block-chaining-密码分组链接">CBC(Cipher Block Chaining) ——密码分组链接</h3>

<p>这种模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算后，再与密钥进行加密。</p>

<p>若第一个块的下标为1，则CBC模式的加密过程为</p>

<script type="math/tex; mode=display">C_{i}=E_{K}(P_{i}\oplus C_),C_{0}=IV</script>

<p>而其解密过程则为</p>

<script type="math/tex; mode=display">P_{i}=D_{K}(C_{i})\oplus C_,C_{0}=IV</script>

<p>这里<script type="math/tex">IV</script>是初始向量，与加密单位长度相同。加密过程是串行的，无法被并行化，而且消息必须被填充到块大小的整数倍。在解密时，从两个邻接的密文块中即可得到一个平文块。因此，解密过程可以被并行化</p>

<p><img src="/img/in-post/aes/cbc.png" width="400" /></p>

<h3 id="ctrcounter-mode-计数器模式">CTR(Counter mode) ——计数器模式</h3>

<p>如图中所示，CTR也会有一个初始向量<script type="math/tex">IV</script>，同时，他还会有一个nonce和counter。nonce由用户指定，用以防御ECB中介绍的“列表攻击”，counter为自增算子，也可以说是数据区块索引。CTR将nonce与counter组合成的数据用key加密，生成的结果再与数据明文异或，得到该区块密文。
CTR不但可以并行加解密，而且不同于CBC，可以在解密时进行随机存取。由于加密和解密过程均可以进行并行处理，CTR很适合运行在多处理器的硬件上。</p>

<p><img src="/img/in-post/aes/ctr.png" width="400" /></p>

<h2 id="参考资料">参考资料</h2>

<p>[1] <a href="http://www.mamicode.com/info-detail-514466.html">密码算法详解——AES</a></p>

<p>[2] <a href="https://github.com/dhuertas/AES">AES项目</a></p>

<p>[3] <a href="https://en.wikipedia.org/wiki/Finite_field_arithmetic">Finite field arithmetic</a></p>

<p>[4] <a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E5%8A%A0%E5%AF%86%E6%A0%87%E5%87%86">高级加密标准wikipedia</a></p>

<p>[5] <a href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">分组密码工作模式</a></p>



                <hr>

                


                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2017/09/05/travis/" data-toggle="tooltip" data-placement="top" title="Travis CI 使用指南">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                
                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread"
                        data-thread-key="/2017/09/05/aes"
                        data-title="AES 加密解读"
                        data-url="http://localhost:4000/2017/09/05/aes/" >
                    </div>
                </div>
                <!-- 多说评论框 end -->
                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#工具" title="工具" rel="2">
                                    工具
                                </a>
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>


<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    // dynamic User by Hux
    var _user = 'huxblog';

    // duoshuo comment query.
    var duoshuoQuery = {short_name: _user };
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "refone-blog";
    var disqus_identifier = "/2017/09/05/aes";
    var disqus_url = "http://localhost:4000/2017/09/05/aes/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/liu-rui-feng-26-35">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/刘瑞丰爱吃卤肉饭">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/Refone">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Refone's Blog 2018
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
